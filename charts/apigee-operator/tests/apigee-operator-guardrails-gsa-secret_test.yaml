# yaml-language-server: $schema=https://raw.githubusercontent.com/quintush/helm-unittest/master/schema/helm-testsuite.json
suite: apigee-operator-guardrails-gsa-secret-test
templates:
- apigee-operator-guardrails-gsa-secret.yaml
release:
  name: test-release
  namespace: test-namespace

tests:
- it: template should fail if file not found
  set:
    guardrails.serviceAccountPath: missing-file.txt
  asserts:
  - failedTemplate:
      errorMessage: "'missing-file.txt' is either an empty file or unreachable"
- it: template should fail if file is empty
  set:
    guardrails.serviceAccountPath: test-empty-file.txt
  asserts:
  - failedTemplate:
      errorMessage: "'test-empty-file.txt' is either an empty file or unreachable"
- it: should render a Secret when guardrails.serviceAccount is provided
  set:
    guardrails:
      serviceAccountPath: test-file.txt
  asserts:
  - isKind:
      of: Secret
  - isAPIVersion:
      of: v1
  - equal:
      path: metadata.name
      value: apigee-operator-guardrails-svc-account
  - equal:
      path: metadata.namespace
      value: test-namespace
  - equal:
      path: metadata.annotations["helm.sh/hook"]
      value: pre-install,pre-upgrade
  - equal:
      path: metadata.annotations["helm.sh/hook-delete-policy"]
      value: before-hook-creation
  - equal:
      path: metadata.annotations["helm.sh/hook-weight"]
      value: "-5"
  - equal:
      path: type
      value: Opaque
  - equal:
      path: data["client_secret.json"]
      value: "eyJ0ZXN0VGV4dCI6ICJoZWxsbyB3b3JsZCJ9"
